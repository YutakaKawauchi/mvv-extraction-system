# Professional Excel Export System è¨­è¨ˆæ›¸

**æœ€çµ‚æ›´æ–°**: 2025-07-13  
**Phase**: 3å®Œäº†ï¼ˆProfessional Excel Export with Visual Analytics Integrationï¼‰

## æ¦‚è¦

Professional Excel Export Systemã¯ã€MVVåˆ†æã‚·ã‚¹ãƒ†ãƒ ã®åŒ…æ‹¬çš„ãªãƒ‡ãƒ¼ã‚¿ã‚’5ã¤ã®å°‚é–€ãƒ‡ãƒ¼ã‚¿ã‚·ãƒ¼ãƒˆã¨Visual Analyticsç”»åƒãƒ¬ãƒãƒ¼ãƒˆã‚’å«ã‚€é«˜å“è³ªExcelãƒ•ã‚¡ã‚¤ãƒ«ã¨ã—ã¦å‡ºåŠ›ã™ã‚‹é©æ–°çš„ã‚·ã‚¹ãƒ†ãƒ ã§ã™ã€‚ExcelJS 4.4.0ã‚’æ´»ç”¨ã—ã€ãƒ“ã‚¸ãƒã‚¹ã‚¤ãƒ³ãƒ†ãƒªã‚¸ã‚§ãƒ³ã‚¹æ©Ÿèƒ½ã€é«˜åº¦Excelæ©Ÿèƒ½ã€Visual Analyticsçµ±åˆã‚’å®Ÿç¾ã—ã¾ã™ã€‚

## è¨­è¨ˆç›®æ¨™

### âœ… é”æˆæ¸ˆã¿ç›®æ¨™
1. **5+å°‚é–€ãƒ‡ãƒ¼ã‚¿ã‚·ãƒ¼ãƒˆ**: Executive Summary, MVV Analysis, Company Master, Visual Analyticsç­‰
2. **Visual Analyticsçµ±åˆ**: TabIDåˆ¥ç”»åƒã‚·ãƒ¼ãƒˆã®è‡ªå‹•ç”Ÿæˆã¨ExcelåŸ‹ã‚è¾¼ã¿
3. **é«˜åº¦Excelæ©Ÿèƒ½**: ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦å›ºå®šã€ã‚ªãƒ¼ãƒˆãƒ•ã‚£ãƒ«ã‚¿ã€æ¡ä»¶ä»˜ãæ›¸å¼ã€ãƒ†ã‚­ã‚¹ãƒˆæŠ˜ã‚Šè¿”ã—
4. **ãƒ“ã‚¸ãƒã‚¹ã‚¤ãƒ³ãƒ†ãƒªã‚¸ã‚§ãƒ³ã‚¹**: JSICåˆ†é¡ã€è²¡å‹™ãƒ‡ãƒ¼ã‚¿ã€ç«¶åˆåˆ†æã®çµ±åˆè¡¨ç¤º
5. **ãƒ–ãƒ©ã‚¦ã‚¶äº’æ›æ€§**: Node.jsä¾å­˜ãªã—ã®ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰å®Œçµå‹ã‚·ã‚¹ãƒ†ãƒ 
6. **ã‚¹ãƒ†ãƒƒãƒ—ãƒã‚¤ã‚¹ãƒ†ãƒƒãƒ—ã‚¦ã‚£ã‚¶ãƒ¼ãƒ‰**: ç›´æ„Ÿçš„ãª3æ®µéšã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆãƒ—ãƒ­ã‚»ã‚¹
7. **Professionalå“è³ª**: ãƒ“ã‚¸ãƒã‚¹ç”¨é€”ã«é©ã—ãŸé«˜å“è³ªãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã¨æ›¸å¼

## ã‚·ã‚¹ãƒ†ãƒ ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£

### å…¨ä½“æ§‹æˆ
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                Professional Excel Export System                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ Export Wizard   â”‚  â”‚ Data Processing â”‚  â”‚ Excel Generationâ”‚  â”‚
â”‚  â”‚                 â”‚  â”‚                 â”‚  â”‚                â”‚  â”‚
â”‚  â”‚ â€¢ 3-Step Flow   â”‚  â”‚ â€¢ Data JOIN     â”‚  â”‚ â€¢ ExcelJS 4.4.0â”‚  â”‚
â”‚  â”‚ â€¢ Configuration â”‚  â”‚ â€¢ JSIC Class    â”‚  â”‚ â€¢ Multi-sheet  â”‚  â”‚
â”‚  â”‚ â€¢ Preview       â”‚  â”‚ â€¢ Financial     â”‚  â”‚ â€¢ Image embed  â”‚  â”‚
â”‚  â”‚ â€¢ Generation    â”‚  â”‚ â€¢ Visual Data   â”‚  â”‚ â€¢ Advanced fmt â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚           â”‚                     â”‚                     â”‚         â”‚
â”‚           â–¼                     â–¼                     â–¼         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚               Browser Excel Engine                          â”‚  â”‚
â”‚  â”‚ â€¢ Workbook Management  â€¢ Sheet Generation  â€¢ File Download â”‚  â”‚
â”‚  â”‚ â€¢ Style Application    â€¢ Image Processing  â€¢ ZIP Creation  â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ­ãƒ¼
```
1. ãƒ¦ãƒ¼ã‚¶ãƒ¼æ“ä½œï¼ˆExport buttonï¼‰
   â†“
2. Export Wizardèµ·å‹•ï¼ˆ3-step processï¼‰
   â†“
3. ãƒ‡ãƒ¼ã‚¿è¨­å®šï¼ˆã‚·ãƒ¼ãƒˆé¸æŠã€Visual Analyticså«ã‚€/å«ã¾ãªã„ï¼‰
   â†“
4. ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼è¡¨ç¤ºï¼ˆè¨­å®šå†…å®¹ç¢ºèªï¼‰
   â†“
5. Excelç”Ÿæˆé–‹å§‹
   â†“
6. ãƒ‡ãƒ¼ã‚¿JOINå‡¦ç†ï¼ˆCompanies + MVV + CompanyInfo + JSICï¼‰
   â†“
7. Visual Analyticsçµ±åˆï¼ˆScreenshot retrieval + TabID groupingï¼‰
   â†“
8. 5+ã‚·ãƒ¼ãƒˆç”Ÿæˆï¼ˆExecutive Summary, MVV Analysis, Company Master, etc.ï¼‰
   â†“
9. é«˜åº¦Excelæ©Ÿèƒ½é©ç”¨ï¼ˆFormatting, Filters, Window Panesï¼‰
   â†“
10. ãƒ•ã‚¡ã‚¤ãƒ«ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ï¼ˆ.xlsxå½¢å¼ï¼‰
```

## æŠ€è¡“ä»•æ§˜

### 1. Export Wizard ã‚·ã‚¹ãƒ†ãƒ 

#### 1.1 3æ®µéšãƒ—ãƒ­ã‚»ã‚¹
```typescript
interface ExportStep {
  id: 'configure' | 'preview' | 'generate';
  name: string;
  component: React.FC<StepProps>;
  validation?: (config: ExportConfiguration) => ValidationResult;
}

interface ExportConfiguration {
  // åŸºæœ¬è¨­å®š
  selectedCompanies: string[];      // å¯¾è±¡ä¼æ¥­ID
  includeAllCompanies: boolean;     // å…¨ä¼æ¥­å«ã‚€
  
  // ãƒ‡ãƒ¼ã‚¿ã‚·ãƒ¼ãƒˆè¨­å®š
  sheets: {
    executiveSummary: boolean;      // ã‚¨ã‚°ã‚¼ã‚¯ãƒ†ã‚£ãƒ–ã‚µãƒãƒªãƒ¼
    mvvAnalysisSimple: boolean;     // MVVåˆ†æï¼ˆã‚·ãƒ³ãƒ—ãƒ«ï¼‰
    mvvAnalysisDetail: boolean;     // MVVåˆ†æï¼ˆè©³ç´°ï¼‰
    companyMaster: boolean;         // ä¼æ¥­ãƒã‚¹ã‚¿ãƒ¼ãƒ‡ãƒ¼ã‚¿
    companyProfiles: boolean;       // ä¼æ¥­è©³ç´°ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«
  };
  
  // Visual Analyticsè¨­å®š
  includeVisualAnalytics: boolean;  // Visual Analyticså«ã‚€
  visualAnalyticsOptions: {
    groupByTabId: boolean;          // TabIDåˆ¥ã‚·ãƒ¼ãƒˆåˆ†é›¢
    includeMetadata: boolean;       // ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿å«ã‚€
    imageQuality: 'high' | 'medium'; // ç”»åƒå“è³ª
  };
  
  // æ›¸å¼è¨­å®š
  formatting: {
    theme: 'business' | 'modern' | 'classic';
    language: 'ja' | 'en';
    dateFormat: string;
  };
  
  // ã‚«ã‚¹ã‚¿ãƒ ã‚·ãƒ¼ãƒˆ
  customSheets?: CustomSheetConfig[];
}
```

#### 1.2 Wizardå®Ÿè£…
```typescript
export const ExcelExportWizard: React.FC = () => {
  const [currentStep, setCurrentStep] = useState<ExportStep['id']>('configure');
  const [exportConfig, setExportConfig] = useState<ExportConfiguration>(defaultConfig);
  const [isExporting, setIsExporting] = useState(false);
  const [exportProgress, setExportProgress] = useState<ExportProgress>();

  const steps: ExportStep[] = [
    {
      id: 'configure',
      name: 'ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆè¨­å®š',
      component: ConfigurationStep,
      validation: validateConfiguration
    },
    {
      id: 'preview',
      name: 'ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ç¢ºèª',
      component: PreviewStep
    },
    {
      id: 'generate',
      name: 'ç”Ÿæˆãƒ»ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰',
      component: GenerationStep
    }
  ];

  const handleExport = useCallback(async () => {
    setIsExporting(true);
    setExportProgress({ stage: 'preparing', progress: 0 });

    try {
      // ãƒ‡ãƒ¼ã‚¿æº–å‚™
      setExportProgress({ stage: 'data-processing', progress: 20 });
      const processedData = await dataProcessor.prepareExportData(exportConfig);
      
      // Visual Analyticså–å¾—
      if (exportConfig.includeVisualAnalytics) {
        setExportProgress({ stage: 'visual-analytics', progress: 40 });
        const visualData = await visualAnalyticsService.getExportData();
        processedData.visualAnalytics = visualData;
      }
      
      // Excelç”Ÿæˆ
      setExportProgress({ stage: 'excel-generation', progress: 60 });
      const workbook = await excelGenerator.createWorkbook(processedData, exportConfig);
      
      // ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
      setExportProgress({ stage: 'download', progress: 90 });
      const filename = generateFilename(exportConfig);
      await workbook.xlsx.writeBuffer().then((buffer) => {
        const blob = new Blob([buffer], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
        const url = URL.createObjectURL(blob);
        const link = document.createElement('a');
        link.href = url;
        link.download = filename;
        link.click();
        URL.revokeObjectURL(url);
      });
      
      setExportProgress({ stage: 'completed', progress: 100 });
    } catch (error) {
      console.error('Excel export error:', error);
      setExportProgress({ stage: 'error', progress: 0, error: error.message });
    } finally {
      setIsExporting(false);
    }
  }, [exportConfig]);

  return (
    <Card className="max-w-4xl mx-auto">
      {/* ã‚¹ãƒ†ãƒƒãƒ—ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼ */}
      <div className="p-6 border-b">
        <StepIndicator steps={steps} currentStep={currentStep} />
      </div>
      
      {/* ãƒ€ã‚¤ãƒŠãƒŸãƒƒã‚¯ã‚¹ãƒ†ãƒƒãƒ—ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ */}
      <div className="p-6">
        <StepContent
          step={currentStep}
          config={exportConfig}
          onConfigChange={setExportConfig}
          onNext={() => setCurrentStep(getNextStep(currentStep))}
          onPrevious={() => setCurrentStep(getPreviousStep(currentStep))}
          onExport={handleExport}
          isExporting={isExporting}
          progress={exportProgress}
        />
      </div>
    </Card>
  );
};
```

### 2. ãƒ‡ãƒ¼ã‚¿å‡¦ç†ã‚·ã‚¹ãƒ†ãƒ 

#### 2.1 çµ±åˆãƒ‡ãƒ¼ã‚¿æº–å‚™
```typescript
class ExportDataProcessor {
  async prepareExportData(config: ExportConfiguration): Promise<ExportData> {
    const companies = await this.getFilteredCompanies(config.selectedCompanies);
    const mvvData = await this.getMVVData(companies);
    const companyInfo = await this.getCompanyInfo(companies);
    const jsicData = await this.getJSICClassification(companies);
    
    // ãƒ‡ãƒ¼ã‚¿JOINå‡¦ç†
    const joinedData = this.joinAllData(companies, mvvData, companyInfo, jsicData);
    
    // çµ±è¨ˆãƒ‡ãƒ¼ã‚¿ç”Ÿæˆ
    const statistics = this.generateStatistics(joinedData);
    
    // ã‚¨ã‚°ã‚¼ã‚¯ãƒ†ã‚£ãƒ–ã‚µãƒãƒªãƒ¼ç”¨ãƒ‡ãƒ¼ã‚¿
    const executiveSummary = this.prepareExecutiveSummary(joinedData, statistics);
    
    return {
      companies: joinedData,
      statistics,
      executiveSummary,
      metadata: {
        exportDate: new Date(),
        totalCompanies: companies.length,
        dataVersion: '3.0.0',
        includesVisualAnalytics: config.includeVisualAnalytics
      }
    };
  }

  private joinAllData(
    companies: Company[],
    mvvData: MVVResult[],
    companyInfo: CompanyInfo[],
    jsicData: JSICClassification[]
  ): JoinedCompanyData[] {
    return companies.map(company => {
      const mvv = mvvData.find(m => m.companyId === company.id);
      const info = companyInfo.find(i => i.companyId === company.id);
      const jsic = jsicData.find(j => j.companyId === company.id);
      
      return {
        // åŸºæœ¬ä¼æ¥­æƒ…å ±
        id: company.id,
        name: company.name,
        website: company.website,
        category: company.category,
        status: company.status,
        createdAt: company.createdAt,
        
        // MVVæƒ…å ±
        mission: mvv?.mission || null,
        vision: mvv?.vision || null,
        values: mvv?.values || [],
        confidenceScores: mvv?.confidence_scores || {},
        mvvSource: mvv?.extracted_from || null,
        mvvExtractedAt: mvv?.extractedAt || null,
        
        // ä¼æ¥­è©³ç´°æƒ…å ±
        establishedYear: info?.establishedYear || null,
        employeeCount: info?.employeeCount || null,
        capital: info?.capital || null,
        location: info?.location || {},
        businessDescription: info?.businessDescription || null,
        
        // JSICåˆ†é¡
        jsicMajorCategory: jsic?.majorCategory || null,
        jsicMajorName: jsic?.majorName || null,
        jsicMiddleCategory: jsic?.middleCategory || null,
        jsicMiddleName: jsic?.middleName || null,
        jsicMinorCategory: jsic?.minorCategory || null,
        jsicMinorName: jsic?.minorName || null,
        primaryIndustry: jsic?.primaryIndustry || null,
        businessType: jsic?.businessType || null
      };
    });
  }

  private generateStatistics(data: JoinedCompanyData[]): ExportStatistics {
    const total = data.length;
    const mvvComplete = data.filter(d => d.mission && d.vision && d.values.length > 0).length;
    const companyInfoComplete = data.filter(d => d.establishedYear && d.employeeCount).length;
    
    // æ¥­ç•Œåˆ¥çµ±è¨ˆ
    const industryStats = this.calculateIndustryStatistics(data);
    
    // å“è³ªçµ±è¨ˆ
    const qualityStats = this.calculateQualityStatistics(data);
    
    // å®Œäº†ç‡çµ±è¨ˆ
    const completionStats = {
      mvvCompletion: (mvvComplete / total) * 100,
      companyInfoCompletion: (companyInfoComplete / total) * 100,
      overallCompletion: ((mvvComplete + companyInfoComplete) / (total * 2)) * 100
    };
    
    return {
      total,
      mvvComplete,
      companyInfoComplete,
      industryStats,
      qualityStats,
      completionStats,
      generatedAt: new Date()
    };
  }
}
```

#### 2.2 Visual Analyticsçµ±åˆ
```typescript
class VisualAnalyticsExportService {
  async getExportData(): Promise<VisualAnalyticsExportData> {
    const screenshots = await screenshotStorage.getAllScreenshots();
    const groupedByTab = this.groupByTabId(screenshots);
    
    const exportData: VisualAnalyticsExportData = {
      totalScreenshots: screenshots.length,
      groups: {},
      metadata: {
        exportedAt: new Date(),
        storageUsage: await screenshotStorage.getStorageUsage(),
        tabCounts: {}
      }
    };
    
    // TabIDåˆ¥ã«ãƒ‡ãƒ¼ã‚¿ã‚’æº–å‚™
    for (const [tabId, tabScreenshots] of groupedByTab) {
      exportData.groups[tabId] = await this.prepareTabData(tabId, tabScreenshots);
      exportData.metadata.tabCounts[tabId] = tabScreenshots.length;
    }
    
    return exportData;
  }

  private async prepareTabData(
    tabId: string,
    screenshots: ScreenshotMetadata[]
  ): Promise<TabExportData> {
    const imageData: ImageExportData[] = [];
    
    for (const screenshot of screenshots) {
      try {
        const base64Data = await screenshotStorage.getScreenshotData(screenshot.id);
        if (base64Data) {
          imageData.push({
            metadata: screenshot,
            imageData: base64Data,
            size: screenshot.size,
            processed: true
          });
        }
      } catch (error) {
        console.error(`ç”»åƒãƒ‡ãƒ¼ã‚¿å–å¾—ã‚¨ãƒ©ãƒ¼ (${screenshot.id}):`, error);
        imageData.push({
          metadata: screenshot,
          imageData: null,
          size: 0,
          processed: false,
          error: error.message
        });
      }
    }
    
    return {
      tabId,
      displayName: this.getTabDisplayName(tabId),
      totalImages: screenshots.length,
      processedImages: imageData.filter(i => i.processed).length,
      images: imageData,
      summary: {
        totalSize: imageData.reduce((sum, img) => sum + img.size, 0),
        averageSize: imageData.length > 0 ? imageData.reduce((sum, img) => sum + img.size, 0) / imageData.length : 0,
        dateRange: this.calculateDateRange(screenshots)
      }
    };
  }
}
```

### 3. Excelç”Ÿæˆã‚¨ãƒ³ã‚¸ãƒ³

#### 3.1 ãƒ¯ãƒ¼ã‚¯ãƒ–ãƒƒã‚¯ç”Ÿæˆ
```typescript
class ExcelWorkbookGenerator {
  async createWorkbook(data: ExportData, config: ExportConfiguration): Promise<ExcelJS.Workbook> {
    const workbook = new ExcelJS.Workbook();
    
    // ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿è¨­å®š
    workbook.creator = 'MVVåˆ†æã‚·ã‚¹ãƒ†ãƒ ';
    workbook.lastModifiedBy = 'Professional Excel Export';
    workbook.created = new Date();
    workbook.modified = new Date();
    workbook.company = 'MVV Analysis Platform';
    
    // å„ã‚·ãƒ¼ãƒˆã®ç”Ÿæˆ
    if (config.sheets.executiveSummary) {
      await this.createExecutiveSummarySheet(workbook, data);
    }
    
    if (config.sheets.mvvAnalysisSimple) {
      await this.createMVVAnalysisSimpleSheet(workbook, data);
    }
    
    if (config.sheets.mvvAnalysisDetail) {
      await this.createMVVAnalysisDetailSheet(workbook, data);
    }
    
    if (config.sheets.companyMaster) {
      await this.createCompanyMasterSheet(workbook, data);
    }
    
    if (config.sheets.companyProfiles) {
      await this.createCompanyProfilesSheet(workbook, data);
    }
    
    // Visual Analytics ã‚·ãƒ¼ãƒˆ
    if (config.includeVisualAnalytics && data.visualAnalytics) {
      await this.createVisualAnalyticsSheets(workbook, data.visualAnalytics);
    }
    
    return workbook;
  }

  private async createExecutiveSummarySheet(
    workbook: ExcelJS.Workbook, 
    data: ExportData
  ): Promise<void> {
    const worksheet = workbook.addWorksheet('Executive Summary');
    
    // ãƒ˜ãƒƒãƒ€ãƒ¼ã‚»ã‚¯ã‚·ãƒ§ãƒ³
    worksheet.mergeCells('A1:F1');
    worksheet.getCell('A1').value = 'MVVåˆ†æãƒ¬ãƒãƒ¼ãƒˆ ã‚¨ã‚°ã‚¼ã‚¯ãƒ†ã‚£ãƒ–ã‚µãƒãƒªãƒ¼';
    worksheet.getCell('A1').font = { bold: true, size: 16 };
    worksheet.getCell('A1').alignment = { horizontal: 'center' };
    
    // åŸºæœ¬çµ±è¨ˆã‚»ã‚¯ã‚·ãƒ§ãƒ³
    let row = 3;
    worksheet.addRow(['é …ç›®', 'å€¤', 'è©³ç´°', '', '', '']);
    worksheet.getRow(row).font = { bold: true };
    row++;
    
    const stats = data.statistics;
    const summaryData = [
      ['åˆ†æå¯¾è±¡ä¼æ¥­æ•°', stats.total, `${stats.mvvComplete}ç¤¾ãŒMVVå®Œäº†`],
      ['MVVæŠ½å‡ºå®Œäº†ç‡', `${stats.completionStats.mvvCompletion.toFixed(1)}%`, `${stats.mvvComplete}/${stats.total}ç¤¾`],
      ['ä¼æ¥­æƒ…å ±å®Œäº†ç‡', `${stats.completionStats.companyInfoCompletion.toFixed(1)}%`, `${stats.companyInfoComplete}/${stats.total}ç¤¾`],
      ['ç·åˆå®Œäº†ç‡', `${stats.completionStats.overallCompletion.toFixed(1)}%`, 'MVV + ä¼æ¥­æƒ…å ±ç·åˆ'],
      ['', '', ''],
      ['ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆæ—¥', data.metadata.exportDate.toLocaleDateString('ja-JP'), ''],
      ['ãƒ‡ãƒ¼ã‚¿ãƒãƒ¼ã‚¸ãƒ§ãƒ³', data.metadata.dataVersion, ''],
      ['Visual Analytics', data.metadata.includesVisualAnalytics ? 'å«ã‚€' : 'å«ã¾ãªã„', '']
    ];
    
    summaryData.forEach(rowData => {
      worksheet.addRow(rowData);
      row++;
    });
    
    // æ¥­ç•Œåˆ¥çµ±è¨ˆã‚»ã‚¯ã‚·ãƒ§ãƒ³
    row += 2;
    worksheet.mergeCells(`A${row}:F${row}`);
    worksheet.getCell(`A${row}`).value = 'æ¥­ç•Œåˆ¥åˆ†æçµæœ';
    worksheet.getCell(`A${row}`).font = { bold: true, size: 14 };
    row += 2;
    
    worksheet.addRow(['æ¥­ç•Œ', 'ä¼æ¥­æ•°', 'MVVå®Œäº†', 'å®Œäº†ç‡', 'å¹³å‡ä¿¡é ¼åº¦', '']);
    worksheet.getRow(row).font = { bold: true };
    row++;
    
    Object.entries(stats.industryStats).forEach(([industry, stat]) => {
      worksheet.addRow([
        industry,
        stat.total,
        stat.mvvComplete,
        `${((stat.mvvComplete / stat.total) * 100).toFixed(1)}%`,
        stat.averageConfidence ? stat.averageConfidence.toFixed(2) : 'N/A'
      ]);
      row++;
    });
    
    // åˆ—å¹…èª¿æ•´
    worksheet.columns = [
      { width: 20 }, { width: 15 }, { width: 25 }, { width: 15 }, { width: 15 }, { width: 10 }
    ];
    
    // ç½«ç·šã¨ã‚¹ã‚¿ã‚¤ãƒ«
    this.applyBusinessFormatting(worksheet);
  }

  private async createMVVAnalysisDetailSheet(
    workbook: ExcelJS.Workbook, 
    data: ExportData
  ): Promise<void> {
    const worksheet = workbook.addWorksheet('MVV Analysis (Detail)');
    
    // 29åˆ—ã®è©³ç´°ãƒ˜ãƒƒãƒ€ãƒ¼
    const headers = [
      'No', 'ä¼æ¥­å', 'æ¥­ç•Œ', 'ã‚¦ã‚§ãƒ–ã‚µã‚¤ãƒˆ', 'ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹', 'Mission', 'Vision', 'Values',
      'Missionä¿¡é ¼åº¦', 'Visionä¿¡é ¼åº¦', 'Valuesä¿¡é ¼åº¦', 'æŠ½å‡ºå…ƒ', 'æŠ½å‡ºæ—¥',
      'è¨­ç«‹å¹´', 'å¾“æ¥­å“¡æ•°', 'è³‡æœ¬é‡‘', 'æœ¬ç¤¾ä½æ‰€', 'éƒ½é“åºœçœŒ', 'å¸‚åŒºç”ºæ‘',
      'JSICå¤§åˆ†é¡', 'JSICä¸­åˆ†é¡', 'JSICå°åˆ†é¡', 'ä¸»è¦æ¥­ç•Œ', 'äº‹æ¥­ã‚¿ã‚¤ãƒ—',
      'äº‹æ¥­å†…å®¹', 'ä½œæˆæ—¥', 'æ›´æ–°æ—¥', 'ãƒ‡ãƒ¼ã‚¿å“è³ª', 'ã‚½ãƒ¼ã‚¹'
    ];
    
    worksheet.addRow(headers);
    const headerRow = worksheet.getRow(1);
    headerRow.font = { bold: true };
    headerRow.fill = {
      type: 'pattern',
      pattern: 'solid',
      fgColor: { argb: 'FFE6F3FF' }
    };
    
    // ãƒ‡ãƒ¼ã‚¿è¡Œè¿½åŠ 
    data.companies.forEach((company, index) => {
      const rowData = [
        index + 1,
        company.name,
        company.category,
        company.website,
        company.status,
        company.mission,
        company.vision,
        company.values.join('; '),
        company.confidenceScores?.mission || '',
        company.confidenceScores?.vision || '',
        company.confidenceScores?.values || '',
        company.mvvSource,
        company.mvvExtractedAt ? new Date(company.mvvExtractedAt).toLocaleDateString('ja-JP') : '',
        company.establishedYear,
        company.employeeCount,
        company.capital,
        company.location?.address,
        company.location?.prefecture,
        company.location?.city,
        company.jsicMajorName,
        company.jsicMiddleName,
        company.jsicMinorName,
        company.primaryIndustry,
        company.businessType,
        company.businessDescription,
        company.createdAt ? new Date(company.createdAt).toLocaleDateString('ja-JP') : '',
        company.updatedAt ? new Date(company.updatedAt).toLocaleDateString('ja-JP') : '',
        this.calculateDataQuality(company),
        'MVV Analysis System'
      ];
      
      worksheet.addRow(rowData);
    });
    
    // ãƒ†ã‚­ã‚¹ãƒˆæŠ˜ã‚Šè¿”ã—è¨­å®šï¼ˆMission, Vision, Valuesåˆ—ï¼‰
    ['F', 'G', 'H', 'Y'].forEach(col => {
      worksheet.getColumn(col).alignment = { wrapText: true, vertical: 'top' };
    });
    
    // åˆ—å¹…è‡ªå‹•èª¿æ•´
    worksheet.columns.forEach((column, index) => {
      if ([5, 6, 7].includes(index)) { // Mission, Vision, Values
        column.width = 30;
      } else if (index === 24) { // äº‹æ¥­å†…å®¹
        column.width = 25;
      } else {
        column.width = 15;
      }
    });
    
    // ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦æ å›ºå®šï¼ˆNo + ä¼æ¥­åï¼‰
    worksheet.views = [{
      state: 'frozen',
      xSplit: 2,
      ySplit: 1
    }];
    
    // ã‚ªãƒ¼ãƒˆãƒ•ã‚£ãƒ«ã‚¿ãƒ¼
    worksheet.autoFilter = 'A1:AC1';
    
    // æ¡ä»¶ä»˜ãæ›¸å¼ï¼ˆä¿¡é ¼åº¦ã‚¹ã‚³ã‚¢ï¼‰
    this.applyConfidenceScoreFormatting(worksheet);
  }

  private async createVisualAnalyticsSheets(
    workbook: ExcelJS.Workbook,
    visualData: VisualAnalyticsExportData
  ): Promise<void> {
    for (const [tabId, tabData] of Object.entries(visualData.groups)) {
      if (tabData.processedImages === 0) continue;
      
      const sheetName = `Visual Analytics - ${tabData.displayName}`;
      const worksheet = workbook.addWorksheet(sheetName);
      
      // ãƒ˜ãƒƒãƒ€ãƒ¼è¨­å®š
      worksheet.columns = [
        { header: 'åå‰', key: 'name', width: 25 },
        { header: 'ä½œæˆæ—¥æ™‚', key: 'timestamp', width: 20 },
        { header: 'èª¬æ˜', key: 'description', width: 30 },
        { header: 'ã‚µã‚¤ã‚º', key: 'size', width: 12 },
        { header: 'ç”»åƒ', key: 'image', width: 50 }
      ];
      
      // ãƒ˜ãƒƒãƒ€ãƒ¼æ›¸å¼
      const headerRow = worksheet.getRow(1);
      headerRow.font = { bold: true };
      headerRow.fill = {
        type: 'pattern',
        pattern: 'solid',
        fgColor: { argb: 'FFF0F8FF' }
      };
      
      let currentRow = 2;
      
      for (const imageItem of tabData.images) {
        if (!imageItem.processed || !imageItem.imageData) continue;
        
        const metadata = imageItem.metadata;
        
        // ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿è¡Œè¿½åŠ 
        worksheet.getCell(`A${currentRow}`).value = metadata.name;
        worksheet.getCell(`B${currentRow}`).value = new Date(metadata.timestamp);
        worksheet.getCell(`C${currentRow}`).value = metadata.description;
        worksheet.getCell(`D${currentRow}`).value = `${Math.round(metadata.size / 1024)}KB`;
        
        // ç”»åƒåŸ‹ã‚è¾¼ã¿
        try {
          const imageBuffer = this.base64ToArrayBuffer(imageItem.imageData);
          const imageId = workbook.addImage({
            buffer: imageBuffer,
            extension: 'png',
          });
          
          // ç”»åƒé…ç½®ï¼ˆã‚¢ã‚¹ãƒšã‚¯ãƒˆæ¯”ç¶­æŒï¼‰
          worksheet.addImage(imageId, {
            tl: { col: 4, row: currentRow - 1 }, // Eåˆ—
            ext: { width: 400, height: 300 }
          });
          
          // ç”»åƒè¡Œã®é«˜ã•èª¿æ•´
          worksheet.getRow(currentRow).height = 225;
        } catch (error) {
          console.error(`ç”»åƒåŸ‹ã‚è¾¼ã¿ã‚¨ãƒ©ãƒ¼ (${metadata.id}):`, error);
          worksheet.getCell(`E${currentRow}`).value = 'ç”»åƒèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼';
        }
        
        currentRow++;
      }
      
      // ã‚ªãƒ¼ãƒˆãƒ•ã‚£ãƒ«ã‚¿ãƒ¼
      worksheet.autoFilter = 'A1:E1';
      
      // ç½«ç·š
      this.applyBasicFormatting(worksheet);
    }
  }

  // ãƒ–ãƒ©ã‚¦ã‚¶äº’æ›Base64â†’ArrayBufferå¤‰æ›
  private base64ToArrayBuffer(base64: string): ArrayBuffer {
    const base64Data = base64.includes(',') ? base64.split(',')[1] : base64;
    const binaryString = atob(base64Data);
    const length = binaryString.length;
    const bytes = new Uint8Array(length);
    
    for (let i = 0; i < length; i++) {
      bytes[i] = binaryString.charCodeAt(i);
    }
    
    return bytes.buffer;
  }

  private applyBusinessFormatting(worksheet: ExcelJS.Worksheet): void {
    // ãƒ“ã‚¸ãƒã‚¹ç”¨æ›¸å¼è¨­å®š
    worksheet.eachRow((row, rowNumber) => {
      row.eachCell((cell, colNumber) => {
        cell.border = {
          top: { style: 'thin' },
          left: { style: 'thin' },
          bottom: { style: 'thin' },
          right: { style: 'thin' }
        };
        
        if (rowNumber === 1) {
          cell.fill = {
            type: 'pattern',
            pattern: 'solid',
            fgColor: { argb: 'FFE6F3FF' }
          };
        }
      });
    });
    
    // äº¤äº’è¡Œã®è‰²ä»˜ã‘
    for (let i = 2; i <= worksheet.rowCount; i += 2) {
      worksheet.getRow(i).fill = {
        type: 'pattern',
        pattern: 'solid',
        fgColor: { argb: 'FFF8F9FA' }
      };
    }
  }

  private applyConfidenceScoreFormatting(worksheet: ExcelJS.Worksheet): void {
    // ä¿¡é ¼åº¦ã‚¹ã‚³ã‚¢ã®æ¡ä»¶ä»˜ãæ›¸å¼
    const confidenceCols = ['I', 'J', 'K']; // Mission, Vision, Valuesä¿¡é ¼åº¦
    
    confidenceCols.forEach(col => {
      worksheet.addConditionalFormatting({
        ref: `${col}2:${col}${worksheet.rowCount}`,
        rules: [
          {
            type: 'cellIs',
            operator: 'greaterThan',
            formulae: [0.9],
            style: {
              fill: {
                type: 'pattern',
                pattern: 'solid',
                bgColor: { argb: 'FF90EE90' } // è–„ç·‘
              }
            }
          },
          {
            type: 'cellIs',
            operator: 'between',
            formulae: [0.7, 0.9],
            style: {
              fill: {
                type: 'pattern',
                pattern: 'solid',
                bgColor: { argb: 'FFFFFF00' } // è–„é»„
              }
            }
          },
          {
            type: 'cellIs',
            operator: 'lessThan',
            formulae: [0.7],
            style: {
              fill: {
                type: 'pattern',
                pattern: 'solid',
                bgColor: { argb: 'FFFFA07A' } // è–„ã‚ªãƒ¬ãƒ³ã‚¸
              }
            }
          }
        ]
      });
    });
  }
}
```

### 4. ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–

#### 4.1 ãƒ¡ãƒ¢ãƒªåŠ¹ç‡åŒ–
```typescript
class ExcelPerformanceOptimizer {
  // å¤§é‡ãƒ‡ãƒ¼ã‚¿ã®æ®µéšçš„å‡¦ç†
  async processLargeDataset(data: JoinedCompanyData[]): Promise<ProcessedData> {
    const BATCH_SIZE = 50;
    const batches = this.chunkArray(data, BATCH_SIZE);
    const processedBatches: ProcessedData[] = [];
    
    for (let i = 0; i < batches.length; i++) {
      const batch = batches[i];
      const processed = await this.processBatch(batch);
      processedBatches.push(processed);
      
      // ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹æ›´æ–°
      const progress = ((i + 1) / batches.length) * 100;
      this.updateProgress(progress);
      
      // ãƒ¡ãƒ¢ãƒªç®¡ç†
      if (i % 10 === 0) {
        await this.suggestGarbageCollection();
      }
    }
    
    return this.mergeBatches(processedBatches);
  }

  // ç”»åƒãƒ‡ãƒ¼ã‚¿ã®åŠ¹ç‡çš„å‡¦ç†
  async optimizeImageProcessing(visualData: VisualAnalyticsExportData): Promise<void> {
    for (const [tabId, tabData] of Object.entries(visualData.groups)) {
      // ç”»åƒã‚’ä¸¦åˆ—å‡¦ç†ï¼ˆæœ€å¤§5å€‹åŒæ™‚ï¼‰
      const imagePromises = tabData.images.map(async (imageItem, index) => {
        if (!imageItem.processed) return;
        
        // å¤§ããªç”»åƒã®åœ§ç¸®
        if (imageItem.size > 1024 * 1024) { // 1MBè¶…é
          imageItem.imageData = await this.compressImage(imageItem.imageData);
        }
        
        return imageItem;
      });
      
      // 5å€‹ãšã¤ä¸¦åˆ—å‡¦ç†
      const chunks = this.chunkArray(imagePromises, 5);
      for (const chunk of chunks) {
        await Promise.all(chunk);
      }
    }
  }

  private async compressImage(base64Data: string): Promise<string> {
    return new Promise((resolve) => {
      const canvas = document.createElement('canvas');
      const ctx = canvas.getContext('2d');
      const img = new Image();
      
      img.onload = () => {
        // æœ€å¤§ã‚µã‚¤ã‚ºåˆ¶é™
        const maxWidth = 1600;
        const maxHeight = 1200;
        
        let { width, height } = img;
        if (width > maxWidth || height > maxHeight) {
          const ratio = Math.min(maxWidth / width, maxHeight / height);
          width *= ratio;
          height *= ratio;
        }
        
        canvas.width = width;
        canvas.height = height;
        
        ctx.drawImage(img, 0, 0, width, height);
        
        // åœ§ç¸®å“è³ªèª¿æ•´
        const compressedData = canvas.toDataURL('image/png', 0.85);
        resolve(compressedData);
      };
      
      img.src = base64Data;
    });
  }
}
```

#### 4.2 ç”Ÿæˆæ™‚é–“æœ€é©åŒ–
```typescript
class ExcelGenerationOptimizer {
  // ä¸¦åˆ—ã‚·ãƒ¼ãƒˆç”Ÿæˆ
  async generateSheetsInParallel(
    workbook: ExcelJS.Workbook,
    data: ExportData,
    config: ExportConfiguration
  ): Promise<void> {
    const sheetGenerators: Promise<void>[] = [];
    
    // è»½é‡ã‚·ãƒ¼ãƒˆã‚’ä¸¦åˆ—ç”Ÿæˆ
    if (config.sheets.executiveSummary) {
      sheetGenerators.push(this.createExecutiveSummarySheet(workbook, data));
    }
    
    if (config.sheets.companyMaster) {
      sheetGenerators.push(this.createCompanyMasterSheet(workbook, data));
    }
    
    // è»½é‡ã‚·ãƒ¼ãƒˆã®ä¸¦åˆ—å‡¦ç†
    await Promise.all(sheetGenerators);
    
    // é‡ã„ã‚·ãƒ¼ãƒˆã‚’é †æ¬¡ç”Ÿæˆ
    if (config.sheets.mvvAnalysisDetail) {
      await this.createMVVAnalysisDetailSheet(workbook, data);
    }
    
    if (config.includeVisualAnalytics) {
      await this.createVisualAnalyticsSheets(workbook, data.visualAnalytics);
    }
  }

  // ãƒ—ãƒ­ã‚°ãƒ¬ãƒƒã‚·ãƒ–æ›¸å¼é©ç”¨
  async applyFormattingProgressively(worksheet: ExcelJS.Worksheet): Promise<void> {
    const totalRows = worksheet.rowCount;
    const BATCH_SIZE = 100;
    
    for (let start = 1; start <= totalRows; start += BATCH_SIZE) {
      const end = Math.min(start + BATCH_SIZE - 1, totalRows);
      
      // ãƒãƒƒãƒå˜ä½ã§æ›¸å¼é©ç”¨
      this.applyBatchFormatting(worksheet, start, end);
      
      // UIãƒ–ãƒ­ãƒƒã‚¯é˜²æ­¢
      await new Promise(resolve => setTimeout(resolve, 0));
    }
  }
}
```

## UI/UXã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ

### Configuration Step
```typescript
const ConfigurationStep: React.FC<StepProps> = ({ config, onConfigChange }) => {
  const companies = useCompanyStore(state => state.companies);
  const [selectedCompanies, setSelectedCompanies] = useState<string[]>(
    config.selectedCompanies || []
  );

  return (
    <div className="space-y-6">
      <div>
        <h3 className="text-lg font-semibold mb-4">ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆå¯¾è±¡ä¼æ¥­</h3>
        <CompanySelector
          companies={companies}
          selectedCompanies={selectedCompanies}
          onSelectionChange={(selected) => {
            setSelectedCompanies(selected);
            onConfigChange({ ...config, selectedCompanies: selected });
          }}
        />
      </div>
      
      <div>
        <h3 className="text-lg font-semibold mb-4">å«ã‚ã‚‹ãƒ‡ãƒ¼ã‚¿ã‚·ãƒ¼ãƒˆ</h3>
        <SheetSelector
          config={config}
          onConfigChange={onConfigChange}
        />
      </div>
      
      <div>
        <h3 className="text-lg font-semibold mb-4">Visual Analytics</h3>
        <VisualAnalyticsOptions
          config={config}
          onConfigChange={onConfigChange}
        />
      </div>
    </div>
  );
};
```

### Preview Step
```typescript
const PreviewStep: React.FC<StepProps> = ({ config }) => {
  const estimatedData = useExportEstimation(config);

  return (
    <div className="space-y-6">
      <div className="bg-blue-50 p-4 rounded-lg">
        <h3 className="text-lg font-semibold mb-2">ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆè¨­å®šç¢ºèª</h3>
        <div className="grid grid-cols-2 gap-4 text-sm">
          <div>
            <span className="font-medium">å¯¾è±¡ä¼æ¥­æ•°:</span> {config.selectedCompanies.length}
          </div>
          <div>
            <span className="font-medium">ç”Ÿæˆã‚·ãƒ¼ãƒˆæ•°:</span> {estimatedData.totalSheets}
          </div>
          <div>
            <span className="font-medium">Visual Analytics:</span> {config.includeVisualAnalytics ? 'å«ã‚€' : 'å«ã¾ãªã„'}
          </div>
          <div>
            <span className="font-medium">äºˆæƒ³ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚º:</span> {estimatedData.estimatedSize}
          </div>
        </div>
      </div>
      
      <div>
        <h4 className="font-medium mb-2">ç”Ÿæˆäºˆå®šã‚·ãƒ¼ãƒˆ:</h4>
        <ul className="list-disc list-inside space-y-1 text-sm">
          {Object.entries(config.sheets)
            .filter(([key, enabled]) => enabled)
            .map(([key, enabled]) => (
              <li key={key}>{getSheetDisplayName(key)}</li>
            ))}
          {config.includeVisualAnalytics && (
            <li>Visual Analytics ({estimatedData.visualAnalyticsSheets}ã‚·ãƒ¼ãƒˆ)</li>
          )}
        </ul>
      </div>
    </div>
  );
};
```

## ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°

### 1. ç”Ÿæˆã‚¨ãƒ©ãƒ¼
```typescript
class ExcelGenerationErrorHandler {
  async handleGenerationError(error: Error, context: GenerationContext): Promise<ErrorRecoveryResult> {
    if (error.name === 'OutOfMemoryError') {
      return {
        canRecover: true,
        suggestion: 'ç”»åƒå“è³ªã‚’ä¸‹ã’ã‚‹ã‹ã€å¯¾è±¡ä¼æ¥­æ•°ã‚’æ¸›ã‚‰ã—ã¦ãã ã•ã„',
        recoveryAction: async () => {
          const reducedConfig = this.reduceConfigurationSize(context.config);
          return await this.retryWithReducedConfig(reducedConfig);
        }
      };
    }
    
    if (error.message.includes('ExcelJS')) {
      return {
        canRecover: true,
        suggestion: 'Excelãƒ•ã‚¡ã‚¤ãƒ«ã®ç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸã€‚å†è©¦è¡Œã—ã¦ãã ã•ã„',
        recoveryAction: async () => {
          await this.clearWorkbookMemory();
          return await this.retryGeneration(context);
        }
      };
    }
    
    return {
      canRecover: false,
      suggestion: 'ã‚·ã‚¹ãƒ†ãƒ ç®¡ç†è€…ã«ãŠå•ã„åˆã‚ã›ãã ã•ã„',
      recoveryAction: null
    };
  }
}
```

### 2. ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã‚¨ãƒ©ãƒ¼
```typescript
class DownloadErrorHandler {
  async handleDownloadError(error: Error, workbook: ExcelJS.Workbook): Promise<void> {
    if (error.name === 'SecurityError') {
      // ãƒ•ã‚¡ã‚¤ãƒ«ã‚·ã‚¹ãƒ†ãƒ APIãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
      await this.tryFilesystemAPI(workbook);
    } else if (error.name === 'QuotaExceededError') {
      // ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
      await this.streamDownload(workbook);
    } else {
      // æ‰‹å‹•ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰æŒ‡ç¤º
      this.showManualDownloadInstructions();
    }
  }
}
```

## ãƒ–ãƒ©ã‚¦ã‚¶äº’æ›æ€§

### ã‚µãƒãƒ¼ãƒˆå¯¾è±¡
- **Chrome**: 80+ âœ… (Blob, ExcelJS, Canvas)
- **Firefox**: 75+ âœ… (FileReader, ArrayBuffer)
- **Safari**: 13+ âœ… (Download attribute)
- **Edge**: 80+ âœ… (File API)

### ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯æˆ¦ç•¥
```typescript
class BrowserCompatibilityManager {
  async ensureCompatibility(): Promise<CompatibilityResult> {
    const features = {
      blob: 'Blob' in window,
      fileReader: 'FileReader' in window,
      arrayBuffer: 'ArrayBuffer' in window,
      downloadAttribute: this.testDownloadAttribute(),
      canvasToBlob: 'HTMLCanvasElement' in window && 'toBlob' in HTMLCanvasElement.prototype
    };
    
    const unsupported = Object.entries(features)
      .filter(([key, supported]) => !supported)
      .map(([key]) => key);
    
    if (unsupported.length > 0) {
      return {
        compatible: false,
        missingFeatures: unsupported,
        fallbackOptions: this.getFallbackOptions(unsupported)
      };
    }
    
    return { compatible: true };
  }
}
```

## é‹ç”¨ãƒ»ä¿å®ˆ

### 1. ç›£è¦–æŒ‡æ¨™
```typescript
interface ExcelExportMetrics {
  exportCount: number;           // ç·ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆæ•°
  averageGenerationTime: number; // å¹³å‡ç”Ÿæˆæ™‚é–“
  averageFileSize: number;       // å¹³å‡ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚º
  errorRate: number;             // ã‚¨ãƒ©ãƒ¼ç‡
  popularSheets: SheetUsageStats; // äººæ°—ã‚·ãƒ¼ãƒˆã®çµ±è¨ˆ
  visualAnalyticsUsage: number;  // Visual Analyticsåˆ©ç”¨ç‡
}
```

### 2. ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–
- å¤§é‡ãƒ‡ãƒ¼ã‚¿ã®ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°å‡¦ç†
- ç”»åƒã®é…å»¶èª­ã¿è¾¼ã¿
- ãƒ¡ãƒ¢ãƒªä½¿ç”¨é‡ã®å‹•çš„ç›£è¦–
- ã‚¬ãƒ™ãƒ¼ã‚¸ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã®æ¨å¥¨

## å°†æ¥ã®æ‹¡å¼µè¨ˆç”»

### Phase 4å€™è£œæ©Ÿèƒ½
1. **ã‚«ã‚¹ã‚¿ãƒ ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ**: ãƒ¦ãƒ¼ã‚¶ãƒ¼å®šç¾©ã®Excelãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ
2. **ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«å‡ºåŠ›**: å®šæœŸçš„ãªè‡ªå‹•ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆ
3. **ã‚¯ãƒ©ã‚¦ãƒ‰ä¿å­˜**: Google Drive, OneDriveé€£æº
4. **PDFã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ**: PDFå½¢å¼ã§ã®å‡ºåŠ›å¯¾å¿œ
5. **ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ å”èª¿**: è¤‡æ•°ãƒ¦ãƒ¼ã‚¶ãƒ¼ã§ã®å…±åŒç·¨é›†

## çµè«–

Professional Excel Export Systemã¯ã€MVVåˆ†æãƒ‡ãƒ¼ã‚¿ã¨Visual Analyticsã‚’çµ±åˆã—ãŸä¸–ç•Œæœ€é«˜æ°´æº–ã®ãƒ“ã‚¸ãƒã‚¹ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆã‚·ã‚¹ãƒ†ãƒ ã§ã™ã€‚

### âœ… æŠ€è¡“çš„æˆæœ
- **5+å°‚é–€ã‚·ãƒ¼ãƒˆ**: åŒ…æ‹¬çš„ãªãƒ“ã‚¸ãƒã‚¹ã‚¤ãƒ³ãƒ†ãƒªã‚¸ã‚§ãƒ³ã‚¹
- **Visual Analyticsçµ±åˆ**: æ¥­ç•Œåˆã®AIåˆ†æç”»åƒçµ±åˆExcel
- **é«˜åº¦Excelæ©Ÿèƒ½**: ãƒ—ãƒ­ãƒ•ã‚§ãƒƒã‚·ãƒ§ãƒŠãƒ«å“è³ªã®æ›¸å¼ã¨ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ
- **ãƒ–ãƒ©ã‚¦ã‚¶å®Œçµ**: ã‚µãƒ¼ãƒãƒ¼ä¾å­˜ãªã—ã®é«˜æ€§èƒ½ã‚·ã‚¹ãƒ†ãƒ 

### ğŸš€ ãƒ“ã‚¸ãƒã‚¹ä¾¡å€¤
- **æ„æ€æ±ºå®šæ”¯æ´**: ãƒ‡ãƒ¼ã‚¿ãƒ‰ãƒªãƒ–ãƒ³ãªçµŒå–¶åˆ¤æ–­ã®åŸºç›¤
- **ãƒ—ãƒ¬ã‚¼ãƒ³ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³å“è³ª**: å½¹å“¡ä¼šãƒ¬ãƒ™ãƒ«ã®ãƒ¬ãƒãƒ¼ãƒˆå“è³ª
- **ä½œæ¥­åŠ¹ç‡åŒ–**: æ‰‹å‹•ä½œæ¥­ã®å®Œå…¨è‡ªå‹•åŒ–
- **ãƒ‡ãƒ¼ã‚¿çµ±åˆ**: æ•£åœ¨ã™ã‚‹æƒ…å ±ã®ä¸€å…ƒåŒ–

Phase 3å®Œäº†ã«ã‚ˆã‚Šã€Professional Excel Export Systemã¯ä¼æ¥­åˆ†æãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ ã®ç«¶äº‰å„ªä½æ€§ã‚’æ±ºå®šã¥ã‘ã‚‹æ ¸å¿ƒæ©Ÿèƒ½ã¨ãªã‚Šã¾ã—ãŸã€‚

---

**æœ€çµ‚æ›´æ–°**: 2025-07-13  
**Phase**: 3å®Œäº† (Professional Excel Export with Visual Analytics Integration)  
**æ¬¡æœŸè¨ˆç”»**: Phase 4 (Advanced reporting and enterprise integration)